// Cursor API Protobuf Definitions
// Extracted from Cursor's workbench.desktop.main.js and cleaned up
// Only includes messages needed for MITM proxy inspection

syntax = "proto3";

package cursor;

// ============================================================
// Core Types
// ============================================================

message CodeChunk {
  string relative_workspace_path = 1;
  int32 start_line_number = 2;
  repeated string lines = 3;
  optional int32 summarization_strategy = 4;  // enum
  string language_identifier = 5;
  optional int32 intent = 6;  // enum
  optional bool is_final_version = 7;
  optional bool is_first_version = 8;
  optional bool contents_are_missing = 9;
  optional bool is_only_included_from_folder = 10;
}

message ModelDetails {
  optional string model_name = 1;
  optional string api_key = 2;
  optional bool enable_ghost_mode = 3;
  // azure_state = 4 (skipped - complex type)
  optional bool enable_slow_pool = 5;
  optional string openai_api_base_url = 6;
  // bedrock_state = 7 (skipped - complex type)
  optional bool max_mode = 8;
}

message Thinking {
  string text = 1;
  string signature = 2;
  string redacted_thinking = 3;
  bool is_last_thinking_chunk = 4;
}

// ============================================================
// ConversationMessage - Individual message in conversation
// ============================================================

message ConversationMessage {
  string text = 1;
  int32 type = 2;  // enum: 1=HUMAN, 2=ASSISTANT
  repeated CodeChunk attached_code_chunks = 3;
  // Fields 4-30 are complex nested types we don't need for basic inspection
  // We only care about text, type, and attached code
  string bubble_id = 13;
  bool is_agentic = 29;
}

// ============================================================
// ExplicitContext - Context provided explicitly
// ============================================================

message ExplicitContext {
  // Placeholder - fields unknown, will decode as raw if present
}

// ============================================================
// StreamUnifiedChatRequest - Main chat request
// ============================================================

message StreamUnifiedChatRequest {
  repeated ConversationMessage conversation = 1;
  optional bool allow_long_file_scan = 2;
  ExplicitContext explicit_context = 3;
  optional bool can_handle_filenames_after_language_ids = 4;
  ModelDetails model_details = 5;
  // linter_errors = 6 (skipped)
  repeated string documentation_identifiers = 7;
  optional string use_web = 8;
  // external_links = 9 (skipped)
  optional ConversationMessage project_context = 10;
  // Many more fields... we care about the main ones
  bool is_chat = 22;
  string conversation_id = 23;
  bool is_agentic = 27;
  bool enable_yolo_mode = 31;
  string yolo_prompt = 32;
}

// ============================================================
// StreamUnifiedChatRequestWithTools - Wrapper for tool calls
// ============================================================

message ClientSideToolResult {
  // Generic placeholder for tool results
  bytes raw_data = 1;
}

message StreamUnifiedChatRequestWithTools {
  oneof request {
    StreamUnifiedChatRequest stream_unified_chat_request = 1;
    ClientSideToolResult client_side_tool_v2_result = 2;
  }
}

// ============================================================
// StreamUnifiedChatResponse - Chat response (streaming)
// ============================================================

message StreamUnifiedChatResponse {
  string text = 1;
  optional string debugging_only_chat_prompt = 2;
  optional int32 debugging_only_token_count = 3;
  // document_citation = 4 (skipped)
  optional string filled_prompt = 5;
  optional bool is_big_file = 6;
  optional string intermediate_text = 7;
  // Many tool-related fields skipped
  optional bool should_break_ai_message = 14;
  optional string server_bubble_id = 22;
  Thinking thinking = 25;
  optional string usage_uuid = 27;
}

// ============================================================
// StreamUnifiedChatResponseWithTools - Response wrapper
// ============================================================

message TracingContext {
  // Placeholder for tracing info
}

message ConversationSummary {
  string summary = 1;
}

message UserRules {
  repeated string rules = 1;
}

message StreamStart {
  // Indicates stream has started
}

message ToolCallV2 {
  string tool_name = 1;
  string tool_id = 2;
  bytes arguments = 3;  // JSON encoded
}

message StreamUnifiedChatResponseWithTools {
  optional TracingContext tracing_context = 6;
  string event_id = 7;
  oneof response {
    bytes client_side_tool_v2_call = 1;
    StreamUnifiedChatResponse stream_unified_chat_response = 2;
    ConversationSummary conversation_summary = 3;
    UserRules user_rules = 4;
    StreamStart stream_start = 5;
  }
}

// ============================================================
// CmdK Service - Command palette AI
// ============================================================

message Range {
  int32 start_line = 1;
  int32 start_column = 2;
  int32 end_line = 3;
  int32 end_column = 4;
}

message StreamCmdKRequest {
  string relative_workspace_path = 1;
  string file_contents = 2;
  string prompt = 3;
  Range selection_range = 4;
  ModelDetails model_details = 5;
}

message StreamCmdKResponse {
  string text = 1;
}

// ============================================================
// NameTab - Tab naming service (contains user messages)
// ============================================================

message NameTabRequest {
  repeated ConversationMessage messages = 1;
}

message NameTabResponse {
  string name = 1;
  string reason = 2;
}

// ============================================================
// StreamUnifiedChatResponseWithToolsIdempotent - Idempotent wrapper
// Used for streaming responses with deduplication
// ============================================================

message ServerChunk {
  // The server_chunk appears to wrap StreamUnifiedChatResponseWithTools
  // but with additional metadata. We'll capture key fields.
  StreamUnifiedChatResponseWithTools response = 2;
}

message WelcomeMessage {
  string message = 1;
}

message StreamUnifiedChatResponseWithToolsIdempotent {
  oneof response {
    ServerChunk server_chunk = 1;
    WelcomeMessage welcome_message = 3;
    uint32 seqno_ack = 4;
  }
}
